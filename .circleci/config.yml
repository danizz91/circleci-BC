version: 2
jobs:
  build:
    docker:
      - image: circleci/node:12
    working_directory: ~/repo
    steps:
      - checkout
      - setup_remote_docker:
          version: 19.03.13
      - run:
          name: Install Docker Compose
          command: |
            curl -L https://github.com/docker/compose/releases/download/1.25.3/docker-compose-`uname -s`-`uname -m` > ~/docker-compose
            chmod +x ~/docker-compose
            sudo mv ~/docker-compose /usr/local/bin/docker-compose
            docker info
            sudo npm install @neuralegion/nexploit-cli -g --unsafe-perm=true || true
      - run:
         name: Save eniroment variables
         command: |
            printf "NEXPLOIT_TOKEN=$NEXPLOIT_TOKEN\nREPEATER=$REPEATER\n" > .env
            cat .env
      - run:
         name: Docker-Compose
         command: |
            sudo docker-compose docker-compose.yml up
            sudo docker-compose --env-file=.env up -d
            sudo docker-compose config
      - run:
          name: Starting Nexploit scan 🏁
          command: >
              echo export SCAN_ID=$(nexploit-cli scan:run --token $NEXPLOIT_TOKEN
              --repeater $REPEATER
              --name "BC Scan from CircleCI"
              --crawler https://brokencrystals.neuralegion.com
              --smart) >> "$BASH_ENV"
      - run: 
          name: Get the output scan url 🔗
          command: |
            printf "Scan was started with ID https://nexploit.app/scans/${SCAN_ID}"
      - run:
          name: Waiting for issues ⏳
          command: >
              (nexploit-cli scan:polling
              --interval 30s
              --timeout 20m
              --token $NEXPLOIT_TOKEN
              --breakpoint medium_issue ${SCAN_ID})
      - run:
          name: Stop Scan 🛑
          when: on_fail
          command: |
              nexploit-cli scan:stop --token $NEXPLOIT_TOKEN ${SCAN_ID}